# OPA sample policies for CFn resource tagging

This repository has sample policy files of the [Open Policy Agent](https://www.openpolicyagent.org/) to check the CloudFormation resource tagging policy.

The following files define resource tagging policies.

- [policies/cfn/tag/tag.rego](https://github.com/x-color/cfn-opa-tag-policy/blob/main/policies/cfn/tag/tag.rego): It check that resources defined in CloudFormation template can have tags. It can check policy for the resources that are able to be used in ap-northeast-1. It is generated by the Go application.
- [policies/cfn/tag/tag.rego](https://github.com/x-color/cfn-opa-tag-policy/blob/main/policies/cfn/tag/name_tag.rego): It requires to attach 'Name' tag to resources.
- [policies/cfn/tag/tag.rego](https://github.com/x-color/cfn-opa-tag-policy/blob/main/policies/cfn/tag/env_tag.rego): It requires to attach 'Env' tag to resources.

The Go application in this repository generates a policy file(policies/cfn/tag/tag.rego).
You should run the application If you want the policy file that can check latest CFn resources.

```bash
# It generates policy file. (required: Go version >= 1.16)
$ go run main.go > policies/cfn/tag/tag.rego
```

## Usage

```bash
# It evaluates the CloudFormation template with the policy files
$ opa eval -d policies -i <CFn Template File> data.policy
```

sample

```bash
$ opa eval -d policies -i testdata/vpc-template.yaml data.policy
{
  "result": [
    {
      "expressions": [
        {
          "value": {
            "allow": false, # Violate the policies if it is 'false'
            "messages": [ # Describe the policies violations
              "'VPC' does not have 'Env' tag",
              "'InternetGateway' does not have 'Name' tag"
            ]
          },
          "text": "data.policy",
          "location": {
            "row": 1,
            "col": 1
          }
        }
      ]
    }
  ]
}
```

## LICENCE

MIT
